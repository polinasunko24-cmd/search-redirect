<!DOCTYPE html>
    <html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ответ от AI</title>
        <!-- ЭТО ВРЕМЕННЫЙ КЭШ-УБИЙЦА! ОН ДОЛЖЕН БЫТЬ ТУТ, ЧТОБЫ БРАУЗЕР НЕ КЭШИРОВАЛ СТАРУЮ ВЕРСИЮ! -->
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">
        <meta name="cache-buster" content="VERSION_BUILD_TIME_PLACEHOLDER"> <!-- Этот плейсхолдер мы будем менять -->
    </head>
    <body>

        <div id="aiAppRoot" data-google-script-url="https://script.google.com/macros/s/AKfycbymjD-NkZ408_tQxf7Sq8-rTpY0zOhKEKnu1scStjSCMVTA1mqMEon6D-Ctb4tIobvsFg/exec">
            <div id="userQuestion" style="font-weight: bold; margin-bottom: 10px;"></div>
            <div id="aiResponse" style="padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9;">Загрузка ответа от AI...</div>
        </div>

        <script>
            function displayAIResponse(message) {
                const responseDiv = document.getElementById('aiResponse');
                if (responseDiv) { responseDiv.innerHTML = message; }
            }

            function handleGoogleScriptResponse(data) {
                alert('>>> handleGoogleScriptResponse ВЫЗВАНА! Получены данные: ' + JSON.stringify(data));
                const oldScript = document.getElementById('googleScriptCall');
                if (oldScript) { oldScript.remove(); }
                if (data && data.error) { displayAIResponse(`Ошибка от AI: ${data.error}`); }
                else if (data && data.answer) { displayAIResponse(data.answer); }
                else { displayAIResponse('AI вернул непонятный ответ.'); }
            }

            function sendRequestToGoogleScriptFromHtml(googleScriptUrl, userQuery, articleText) {
                alert('>>> sendRequestToGoogleScriptFromHtml: НАЧАЛО ОТПРАВКИ ЗАПРОСА');
                alert('>>> sendRequestToGoogleScriptFromHtml: userQuery: ' + userQuery);
                alert('>>> sendRequestToGoogleScriptFromHtml: Входящий GoogleScriptUrl: ' + googleScriptUrl);
                displayAIResponse('Загрузка ответа от AI...');
                const encodedUserQuery = encodeURIComponent(userQuery);
                const encodedArticleText = encodeURIComponent(articleText);
                const script = document.createElement('script');
                script.id = 'googleScriptCall';
                // ДОБАВЛЯЕМ cachebuster ПРЯМО СЮДА В URL!
                script.src = `${googleScriptUrl}?cachebuster=${new Date().getTime()}&callback=handleGoogleScriptResponse&query=${encodedUserQuery}&article=${encodedArticleText}`;
                alert('>>> sendRequestToGoogleScriptFromHtml: Сформированный URL запроса: ' + script.src);
                document.head.appendChild(script);
                alert('>>> sendRequestToGoogleScriptFromHtml: Скрипт-тег ДОБАВЛЕН в <head>.');
                script.onerror = function() {
                    alert('>>> sendRequestToGoogleScriptFromHtml: КРИТИЧЕСКАЯ ОШИБКА: script.onerror СРАБОТАЛ! Не удалось загрузить скрипт AI.');
                    displayAIResponse('Критическая ошибка: не удалось загрузить скрипт AI. Проверьте URL и сеть.');
                    const oldScript = document.getElementById('googleScriptCall');
                    if (oldScript) { oldScript.remove(); }
                };
            }

            document.addEventListener('DOMContentLoaded', () => {
                alert('>>> DOMContentLoaded: Страница ДОГРУЗИЛАСЬ. JS ИНИЦИАЛИЗИРОВАН.');
                const appRoot = document.getElementById('aiAppRoot');
                const googleScriptUrl = appRoot ? appRoot.dataset.googleScriptUrl : null;
                alert('>>> DOMContentLoaded: URL Google Script прочитан из HTML: ' + googleScriptUrl);
                if (!googleScriptUrl) {
                    alert('>>> DOMContentLoaded: КРИТИЧЕСКАЯ ОШИБКА: Не удалось прочитать GOOGLE_SCRIPT_WEB_APP_URL из HTML. Проверьте HTML-разметку!');
                    displayAIResponse('Критическая ошибка: неверно указан URL Google Script в HTML-теге. Обратитесь к разработчику.');
                    return;
                }
                const urlParams = new URLSearchParams(window.location.search);
                const userQuery = urlParams.get('query');
                alert('>>> DOMContentLoaded: userQuery из URL: ' + userQuery);
                const hardcodedArticleContent = "Основные положения: 1.1. Регламент создания и ведения чат-бота Заботекс (далее - Регламент) определяет порядок взаимодействия между Администратором чат-бота и сотрудника при постановке задачи по разработке, внедрении, модификации и корректировке чат-бота Заботекс, разработанного на платформе Bitrix24. 1.2. Регламент применим для сотрудников, участвующих в создании, ведении, модификации и корректировке чат-бота Заботекс, разработанного на платформе Bitrix24. 1.3. При создании нового чат-бота, разработке нового функционала или корректировке существующего функционала Заботекс необходимо строго соблюдать положения настоящего Регламента.";
                alert('>>> DOMContentLoaded: articleContent ЗАХАРДКОЖЕН: ' + hardcodedArticleContent.substring(0, 50) + '...');
                const userQuestionDiv = document.getElementById('userQuestion');
                if (userQuestionDiv) { userQuestionDiv.textContent = `Ваш вопрос: "${userQuery || 'Не задан'}"`; }
                if (userQuery) {
                    alert('>>> DOMContentLoaded: Все данные есть (вопрос и статья)! Вызываем sendRequestToGoogleScriptDirect!');
                    sendRequestToGoogleScriptFromHtml(googleScriptUrl, userQuery, hardcodedArticleContent);
                } else {
                    alert('>>> DOMContentLoaded: ОШИБКА - userQuery отсутствует! Не вызываем sendRequestToGoogleScriptDirect.');
                    displayAIResponse('Ошибка: Отсутствует вопрос пользователя в URL.');
                }
            });
        </script>

    </body>
    </html>
