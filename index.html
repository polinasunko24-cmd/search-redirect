<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ЗАПУЩЕН! (ПРОВЕРКА)</title>
    
    <!-- КЭШ-УБИЙЦЫ НА ВСЕ СЛУЧАИ ЖИЗНИ. ИЗМЕНИ КАЖДЫЙ РАЗ, ЕСЛИ НЕ ОБНОВИЛОСЬ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-master-html" content="1717895000000_ULTRA_MEGA_KILL_V2"> <!-- ИЗМЕНИ ЭТО, ЕСЛИ НЕ ОБНОВИЛОСЬ -->
    
    <style>
        body { font-family: 'Arial', sans-serif; margin: 20px; background-color: #333; color: #eee; text-align: center; }
        .container { background-color: #222; border: 2px solid #5f5; padding: 30px; border-radius: 10px; max-width: 600px; margin: 50px auto; box-shadow: 0 0 15px rgba(0,255,0,0.5); }
        h1 { color: #5f5; font-size: 2em; }
        p { font-size: 1.1em; }
        #status-display { font-weight: bold; color: #0f0; margin-top: 20px; border: 1px dashed #0f0; padding: 10px; background-color: #1a1a1a; }
        .error-message { color: #f55; }
        a { color: #5af; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <div class="container">
        <h1>СТРАНИЦА AI ЗАПУЩЕНА И РАБОТАЕТ!</h1>
        <p>Если вы это видите, значит HTML загрузился успешно.</p>
        <p id="status-display">Запуск JS и подготовка к запросу...</p>
    </div>

    <!-- ************************************************************************* -->
    <!-- ВЕСЬ JAVASCRIPT-КОД "ГОНЦА". -->
    <!-- ************************************************************************* -->
    <script>
        // АКТУАЛЬНЫЙ URL ТВОЕГО GOOGLE SCRIPT (ДОЛЖЕН ВЫДАВАТЬ ПРОСТО ТЕКСТ)
        const GOOGLE_SCRIPT_RAW_ANSWER_URL = 'https://script.google.com/macros/s/AKfycbzhRl6o_wSuwUeviKVWQ5vorTvw1_7Xw_bES2gqbmlGnUo5MFwRe6rZJFmCR5X1wBzd/exec';

        // Обновляет статус на странице
        function updateStatus(message, isError = false) {
            const statusDiv = document.getElementById('status-display');
            if (statusDiv) {
                statusDiv.innerHTML = message;
                statusDiv.className = isError ? 'error-message' : '';
            }
        }

        // Запуск логики после загрузки DOM
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus("JS ЗАПУЩЕН! Читаем URL параметры...");

            const urlParams = new URLSearchParams(window.location.search);
            const userQuery = urlParams.get('query');
            
            if (!userQuery) {
                updateStatus('Ошибка: Отсутствует userQuery в URL.', true);
                return;
            }

            updateStatus(`UserQuery: "${userQuery}". Загружаем статью...`);

            // Загружаем полную статью с GitHub Pages
            fetch('article_for_demo.txt.txt') // Убедись, что ПУТЬ ЗАГРУЗКИ К article_for_demo.txt.txt ВЕРЕН!
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Статус: ${response.status} ${response.statusText}. Проверьте путь article_for_demo.txt.txt.`);
                    }
                    return response.text();
                })
                .then(fullArticleContent => {
                    updateStatus('Статья загружена. Формируем контекст...');
                    
                    const sentences = fullArticleContent.split(/[\.\?!;]\s*|\r?\n\s*/).filter(s => s.trim().length > 0);
                    const queryKeywords = userQuery.toLowerCase().split(/\s+/).filter(word => word.length > 2);

                    let relevantContext = [];
                    for (const sentence of sentences) {
                        const lowerSentence = sentence.toLowerCase();
                        if (queryKeywords.some(keyword => lowerSentence.includes(keyword))) {
                            relevantContext.push(sentence.trim());
                            if (relevantContext.length >= 3) break;
                        }
                    }
                    let articleForAI = relevantContext.join(" ") || fullArticleContent.substring(0, 300);
                    if (articleForAI.length > 1000) {
                        articleForAI = articleForAI.substring(0, 1000) + "...";
                    }

                    updateStatus('Контекст сформирован. Перенаправляем на Google Script...');

                    const encodedUserQuery = encodeURIComponent(userQuery);
                    const encodedArticleForAI = encodeURIComponent(articleForAI);

                    let redirectUrl = `${GOOGLE_SCRIPT_RAW_ANSWER_URL}?query=${encodedUserQuery}&article=${encodedArticleForAI}`;
                    
                    // console.log("Final redirect URL:", redirectUrl); // Для отладки в консоли
                    window.location.replace(redirectUrl); // Это немедленно перенаправит страницу
                })
                .catch(error => {
                    updateStatus(`КРИТИЧЕСКАЯ ОШИБКА: Не удалось загрузить статью: ${error.message}. Проверьте <a href="article_for_demo.txt.txt" target="_blank">файл статьи</a>.`, true);
                });
        });
    </script>
    <!-- ************************************************************************* -->

</body>
</html>
