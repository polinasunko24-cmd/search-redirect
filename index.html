<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ответ от AI</title>
</head>
<body>

    <div id="userQuestion" style="font-weight: bold; margin-bottom: 10px;"></div>
    <div id="aiResponse" style="padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9;">Загрузка ответа от AI...</div>

    <script>
        const GOOGLE_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbymjD-NkZ408_tQxf7Sq8-rTpY0zOhKEKnu1scStjSCMVTA1mqMEon6D-Ctb4tIobvsFg/exec';
        function handleGoogleScriptResponse(data) {
            const oldScript = document.getElementById('googleScriptCall');
            if (oldScript) { oldScript.remove(); }
            if (data && data.error) {
                alert('ОШИБКА ОТ AI: ' + data.error);
                displayAIResponse(`Ошибка от AI: ${data.error}`);
            } else if (data && data.answer) {
                alert('ОТВЕТ ОТ AI: ' + data.answer);
                displayAIResponse(data.answer);
            } else {
                alert('AI вернул непонятный ответ.');
                displayAIResponse('AI вернул непонятный ответ.');
            }
        }
        function sendRequestToGoogleScript(userQuery, articleText) {
            displayAIResponse('Загрузка ответа от AI...'); 
            const encodedUserQuery = encodeURIComponent(userQuery);
            const encodedArticleText = encodeURIComponent(articleText);
            const script = document.createElement('script');
            script.id = 'googleScriptCall';
            script.src = `${GOOGLE_SCRIPT_WEB_APP_URL}?callback=handleGoogleScriptResponse&query=${encodedUserQuery}&article=${encodedArticleText}`;
            document.head.appendChild(script);
            script.onerror = function() {
                alert('КРИТИЧЕСКАЯ ОШИБКА: Фронтенд не смог загрузить скрипт AI. Проверьте URL Google Script и/или сетевое подключение.');
                displayAIResponse('Критическая ошибка: не удалось загрузить скрипт AI. Проверьте URL и сеть.');
                const oldScript = document.getElementById('googleScriptCall');
                if (oldScript) { oldScript.remove(); }
            };
        }
        function displayAIResponse(message) {
            const responseDiv = document.getElementById('aiResponse');
            if (responseDiv) { responseDiv.innerHTML = message; } else { console.warn('Элемент #aiResponse не найден в DOM.'); }
        }
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const userQuery = urlParams.get('query');
            fetch('article_for_demo.txt.txt')
                .then(response => {
                    if (!response.ok) { throw new Error(`Не удалось загрузить статью: ${response.statusText}.`); }
                    return response.text();
                })
                .then(articleContent => {
                    const userQuestionDiv = document.getElementById('userQuestion');
                    if (userQuestionDiv) { userQuestionDiv.textContent = `Ваш вопрос: "${userQuery || 'Не задан'}"`; }
                    if (userQuery && articleContent) {
                        sendRequestToGoogleScript(userQuery, articleContent);
                    } else if (!userQuery) {
                        displayAIResponse('Ошибка: Отсутствует вопрос пользователя в URL.');
                    } else {
                        displayAIResponse('Ошибка: Отсутствует текст статьи для анализа.');
                    }
                })
                .catch(error => {
                    displayAIResponse(`Критическая ошибка при загрузке статьи: ${error.message}`);
                });
        });
    </script>

</body>
</html>
