<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ответ от AI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        #loadingSpinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            display: none; /* Скрыт по умолчанию */
            margin: 30px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #answerContainer {
            margin-top: 20px;
            text-align: left;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        #aiAnswer {
            white-space: pre-wrap; /* Сохраняет форматирование абзацев */
            font-size: 1.1em;
            line-height: 1.6;
            color: #555;
        }
        #userQuestion {
            font-style: italic;
            color: #777;
            margin-bottom: 15px;
        }
        #errorMessage {
            color: #e74c3c;
            font-weight: bold;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="mainTitle">Получение ответа от AI...</h1>
        <div id="loadingSpinner"></div>
        <p id="userQuestion" style="display: none;"></p>
        <div id="answerContainer" style="display: none;">
            <h2>Ответ AI:</h2>
            <p id="aiAnswer"></p>
        </div>
        <p id="errorMessage"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const mainTitle = document.getElementById('mainTitle');
            const userQuestionElem = document.getElementById('userQuestion');
            const answerContainer = document.getElementById('answerContainer');
            const aiAnswerElem = document.getElementById('aiAnswer');
            const errorMessageElem = document.getElementById('errorMessage');

            loadingSpinner.style.display = 'block'; // Показываем спиннер сразу

            // --- ЭТО ПРАВИЛЬНАЯ ССЫЛКА НА ТВОЙ "Секретарь" на Яндекс.Облаке (ЧЕРЕЗ МАРШРУТ /proxy!) ---
            const yandexCloudFunctionUrl = 'https://functions.yandexcloud.net/d4e3iuogjmrv7uqiou4q/proxy';
            
            // --- ЭТО ПУБЛИЧНАЯ ССЫЛКА НА ТВОЙ "Архив" (базу знаний .txt) на GitHub Pages ---
            const knowledgeBaseUrl = 'https://raw.githubusercontent.com/polinasunko24-cmd/search-redirect/refs/heads/main/article_for_demo.txt.txt';

            // Получаем параметры из URL
            const urlParams = new URLSearchParams(window.location.search);
            const userQuery = urlParams.get('query'); // Это твой вопрос из Заботикса

            if (!userQuery) {
                loadingSpinner.style.display = 'none';
                mainTitle.textContent = 'Ошибка!';
                errorMessageElem.textContent = 'Не удалось найти вопрос в URL. Пожалуйста, убедитесь, что ссылка сформирована правильно (формат: ?query=ВОПРОС).';
                errorMessageElem.style.display = 'block';
                return;
            }

            userQuestionElem.textContent = `Ваш вопрос: "${decodeURIComponent(userQuery)}"`;
            userQuestionElem.style.display = 'block';

            // Шаг 1: Читаем базу знаний с GitHub Pages ("Архив")
            fetch(knowledgeBaseUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status} при загрузке базы знаний. Проверьте ссылку на Archive.`);
                    }
                    return response.text();
                })
                .then(articleText => {
                    // Шаг 2: Отправляем запрос на твой Яндекс.Облачный прокси ("Секретарь")
                    // Теперь это идет на маршрут /proxy, который сам обрабатывает CORS!
                    return fetch(yandexCloudFunctionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userQuery: decodeURIComponent(userQuery), // Декодируем, если вопрос был закодирован в URL
                            articleText: articleText
                        })
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Ошибка от AI-сервера: ${response.statusText || 'Неизвестная ошибка'}. Возможно, некорректно настроена функция Яндекс.Облака, или она возвращает ошибку.`);
                    }
                    return response.json();
                })
                .then(data => {
                    loadingSpinner.style.display = 'none';
                    mainTitle.textContent = 'Готово!';

                    if (data.answer) {
                        aiAnswerElem.textContent = data.answer;
                        answerContainer.style.display = 'block';
                    } else if (data.error) {
                         // Если функция вернула ошибку в JSON
                        errorMessageElem.textContent = `Ошибка от AI-сервера: ${data.error}`;
                        errorMessageElem.style.display = 'block';
                    }
                    else {
                        throw new Error('Ответ AI пуст или имеет неверный формат. Проверьте логи на Яндекс.Облаке.');
                    }
                })
                .catch(error => {
                    console.error('Ошибка в процессе получения ответа:', error);
                    loadingSpinner.style.display = 'none';
                    mainTitle.textContent = 'Произошла ошибка!';
                    errorMessageElem.textContent = `Что-то пошло не так: ${error.message}. Пожалуйста, попробуйте снова или проверьте настройки консоли разработчика в браузере (F12).`;
                    errorMessageElem.style.display = 'block';
                });
        });
    </script>
</body>
</html>
