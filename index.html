<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Перенаправление к AI</title>
    
    <!-- КЭШ-УБИЙЦА ДЛЯ HTML -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-buster" content="1717888790123_FINAL_ASSULT_V2"> <!-- УНИКАЛЬНОЕ ЗНАЧЕНИЕ СЕЙЧАС! -->
    
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f0f0f0; }
        h1 { color: #333; }
        p { color: #555; }
        #loadingStatus { font-weight: bold; color: #007bff; }
        .error-message { color: #dc3545; }
    </style>
</head>
<body>

    <h1>Обработка запроса...</h1>
    <p>Ваш запрос сейчас обрабатывается AI. Вы будете перенаправлены на страницу с ответом.</p>
    <p id="loadingStatus">Загрузка статьи и выбор контекста...</p>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const userQuery = urlParams.get('query');
            
            // --- АКТУАЛЬНЫЙ URL ТВОЕГО GOOGLE SCRIPT (ДОЛЖЕН ВЫДАВАТЬ ПРОСТО ТЕКСТ) ---
            const GOOGLE_SCRIPT_RAW_ANSWER_URL = 'https://script.google.com/macros/s/AKfycby-Z_vjIFKzVySfFi-ltesSUJB82JSbqnoFtRB6vd0zDbsonIbW4soocxI-AUgiCUwevQ/exec';

            if (!userQuery) {
                alert('Ошибка: Отсутствует вопрос пользователя в URL. Невозможно перенаправить.');
                document.body.innerHTML = '<h1 class="error-message">Ошибка: Отсутствует вопрос пользователя.</h1><p>Убедитесь, что Заботикс передает параметр "query".</p>';
                return;
            }

            document.getElementById('loadingStatus').innerText = 'Загрузка полной статьи для обработки...';

            // Загружаем полную статью с GitHub Pages
            fetch('article_for_demo.txt.txt') // Убедись, что ПУТЬ ЗАГРУЗКИ К article_for_demo.txt.txt ВЕРЕН!
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Статус: ${response.status} ${response.statusText}. Возможно, файл не найден или путь неверен.`);
                    }
                    return response.text();
                })
                .then(fullArticleContent => {
                    document.getElementById('loadingStatus').innerText = 'Статья загружена. Выбор релевантного контекста и перенаправление...';
                    
                    // --- ЛОГИКА: Извлечение релевантных предложений ВО ФРОНТЕНДЕ ---
                    const sentences = fullArticleContent.split(/[\.\?!;]\s*|\r?\n\s*/).filter(s => s.trim().length > 0);
                    const queryKeywords = userQuery.toLowerCase().split(/\s+/).filter(word => word.length > 2); // Ключевые слова из запроса. Минимальная длина слова 3 символа.

                    let relevantContext = [];
                    for (const sentence of sentences) {
                        const lowerSentence = sentence.toLowerCase();
                        if (queryKeywords.some(keyword => lowerSentence.includes(keyword))) {
                            relevantContext.push(sentence.trim());
                            if (relevantContext.length >= 3) break; // Ограничиваемся 3-мя самыми релевантными предложениями
                        }
                    }
                    let articleForAI = relevantContext.join(" ") || fullArticleContent.substring(0, 300); // Если ничего не нашли, берем начало статьи (до 300 символов)
                    if (articleForAI.length > 1000) { // Еще раз обрезаем, если контекст все равно огромен
                        articleForAI = articleForAI.substring(0, 1000) + "...";
                    }
                    // --- КОНЕЦ ЛОГИКИ ИЗВЛЕЧЕНИЯ КОНТЕКСТА ---

                    const encodedUserQuery = encodeURIComponent(userQuery);
                    const encodedArticleForAI = encodeURIComponent(articleForAI); // <<-- ВОТ ОН! ОБРЕЗАННЫЙ КОНТЕКСТ!

                    let redirectUrl = `${GOOGLE_SCRIPT_RAW_ANSWER_URL}?query=${encodedUserQuery}&article=${encodedArticleForAI}`;
                    
                    alert('>>> Перенаправление на Google Script для получения ответа...');
                    window.location.replace(redirectUrl);
                })
                .catch(error => {
                    alert(`Критическая ошибка при загрузке статьи: ${error.message}`);
                    document.body.innerHTML = `<h1 class="error-message">Критическая ошибка:</h1><p class="error-message">Не удалось загрузить статью для AI: ${error.message}.<br>Проверьте, существует ли файл <code>article_for_demo.txt.txt</code> по этому <a href="article_for_demo.txt.txt" target="_blank">пути</a>, и доступен ли он.</p>`;
                });
        });
    </script>

</body>
</html>
