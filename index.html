<script>
    // ***************************************************************
    // НОВЫЙ КОД "ГОНЦА" ДЛЯ ОБХОДА CORS ЧЕРЕЗ JSONP (СКРИПТ-ТЕГ)
    // ВСТАВЬ ЭТО ВМЕСТО ТВОЕЙ СТАРОЙ ЛОГИКИ ОТПРАВКИ ЗАПРОСА К AI
    // ***************************************************************

    // ТВОЙ НОВЫЙ АБСОЛЮТНЫЙ URL К GOOGLE APPS SCRIPT
    const GOOGLE_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzlaRV0hwNfdzM1mzOkaP8wymT0HfmLRF-DRAWNDRkVdgTKSGYcJlazVnCyCHZwBxjbg/exec';

    // Эта глобальная функция будет ВЫЗВАНА твоим Google Script
    // (потому что мы запросили 'callback=handleGoogleScriptResponse')
    function handleGoogleScriptResponse(data) {
        // Убедимся, что скрипт-тег, который сделал запрос, удален
        const oldScript = document.getElementById('googleScriptCall');
        if (oldScript) {
            oldScript.remove();
        }

        if (data.error) {
            console.error('Ошибка от Google Script (JSONP):', data.error);
            displayAIResponse(`Что-то пошло не так на стороне AI: ${data.error}`); // Отображаем ошибку от скрипта
        } else {
            console.log('Ответ от Google Script (JSONP):', data.answer);
            displayAIResponse(data.answer); // Отображаем полученный ответ
        }
    }

    // Эта функция будет отправлять запрос к Google Script
    // Она принимает userQuery (вопрос пользователя) и articleText (текст статьи)
    function sendRequestToGoogleScript(userQuery, articleText) {
        // Очищаем предыдущее сообщение об ошибке (если было)
        displayAIResponse('Загрузка ответа от AI...'); 

        // Кодируем параметры, чтобы они были безопасны для URL
        const encodedUserQuery = encodeURIComponent(userQuery);
        const encodedArticleText = encodeURIComponent(articleText);

        // Создаем динамический JS-скрипт тег
        const script = document.createElement('script');
        script.id = 'googleScriptCall'; // Даем ID, чтобы потом легко удалить
        
        // Формируем URL с параметрами и именем callback-функции
        // ОБРАТИ ВНИМАНИЕ: МЫ ИСПОЛЬЗУЕМ GET-ПАРАМЕТРЫ!
        script.src = `${GOOGLE_SCRIPT_WEB_APP_URL}?callback=handleGoogleScriptResponse&query=${encodedUserQuery}&article=${encodedArticleText}`;
        
        // Добавляем скрипт-тег в <head> документа, чтобы он загрузился и выполнился
        document.head.appendChild(script);

        // Это обработчик на случай, если скрипт вообще не загрузится (например, неверный URL или проблема с сетью)
        script.onerror = function() {
            console.error('КРИТИЧЕСКАЯ ОШИБКА: Скрипт Google Script не удалось загрузить.');
            displayAIResponse('Произошла критическая ошибка при запросе к AI (проблемы с загрузкой скрипта). Пожалуйста, проверьте URL и подключение.');
            const oldScript = document.getElementById('googleScriptCall');
            if (oldScript) {
                oldScript.remove();
            }
        };
    }
