<script>
    const GOOGLE_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzlaRV0hwNfdzM1mzOkaP8wymT0HfmLRF-DRAWNDRkVdgTKSGYcJlazVnCyCHZ_wBxjbg/exec';

    function handleGoogleScriptResponse(data) {
        if (data.error) {
            alert('ОШИБКА ОТ AI: ' + data.error);
        } else {
            alert('ОТВЕТ ОТ AI: ' + data.answer);
        }

        const oldScript = document.getElementById('googleScriptCall');
        if (oldScript) {
            oldScript.remove();
        }

        if (data.error) {
            displayAIResponse(`Что-то пошло не так на стороне AI: ${data.error}`);
        } else {
            displayAIResponse(data.answer);
        }
    }

    function sendRequestToGoogleScript(userQuery, articleText) {
        displayAIResponse('Загрузка ответа от AI...'); 

        const encodedUserQuery = encodeURIComponent(userQuery);
        const encodedArticleText = encodeURIComponent(articleText);

        const script = document.createElement('script');
        script.id = 'googleScriptCall';
        
        script.src = `${GOOGLE_SCRIPT_WEB_APP_URL}?callback=handleGoogleScriptResponse&query=${encodedUserQuery}&article=${encodedArticleText}`;
        
        document.head.appendChild(script);

        script.onerror = function() {
            displayAIResponse('Критическая ошибка: не удалось загрузить скрипт AI. Проверьте URL и сеть.');
            const oldScript = document.getElementById('googleScriptCall');
            if (oldScript) {
                oldScript.remove();
            }
        };
    }

    function displayAIResponse(message) {
        const responseDiv = document.getElementById('aiResponse');
        if (responseDiv) {
            responseDiv.innerHTML = message;
        } else {
            console.warn('Элемент с ID "aiResponse" не найден.');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const userQuery = urlParams.get('query');
        
        fetch('article_for_demo.txt.txt')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Не удалось загрузить статью: ${response.statusText}.`);
                }
                return response.text();
            })
            .then(articleContent => {
                const userQuestionDiv = document.getElementById('userQuestion');
                if (userQuestionDiv) {
                    userQuestionDiv.textContent = `Ваш вопрос: "${userQuery || 'Не задан'}"`;
                }
                
                if (userQuery && articleContent) {
                    sendRequestToGoogleScript(userQuery, articleContent);
                } else if (!userQuery) {
                    displayAIResponse('Ошибка: Отсутствует вопрос пользователя в URL.');
                } else {
                    displayAIResponse('Ошибка: Отсутствует текст статьи для анализа.');
                }
            })
            .catch(error => {
                displayAIResponse(`Критическая ошибка: Не удалось загрузить текст статьи. ${error.message}`);
            });
    });
</script>

<div id="userQuestion" style="font-weight: bold; margin-bottom: 10px;"></div>
<div id="aiResponse" style="padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9;">Здесь будет ответ от AI...</div>
